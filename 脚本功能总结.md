# PVE K8S + KubeSphere 一键部署工具功能总结

## 脚本概览
- **文件名**: `one-click-pve-k8s.sh`
- **版本**: v4.0
- **总行数**: 2,529行
- **函数数量**: 61个
- **注释行数**: 256行
- **菜单选项**: 22个

## 核心功能模块

### 1. 部署功能（菜单选项 1-5）
- **一键全自动部署**：完整的K8S集群和KubeSphere部署流程
- **下载云镜像**：自动下载Debian 12云镜像
- **创建虚拟机**：批量创建K8S节点虚拟机
- **部署K8S集群**：安装Docker、containerd、K8S组件，初始化集群
- **部署KubeSphere**：安装KubeSphere平台

### 2. 修复功能（菜单选项 6-9, 12）
- **修复Docker和K8S安装**：重新安装和配置容器运行时
- **修复K8S集群**：修复集群连接、节点加入问题
- **修复网络连接**：解决DNS、网络配置问题
- **修复SSH配置**：清理SSH密钥冲突，修复连接问题
- **一键修复所有问题**：按步骤自动修复所有检测到的问题

### 3. 诊断功能（菜单选项 10-11, 15-17, 21）
- **系统诊断**：全面检查虚拟机、SSH、Docker/K8S、集群状态
- **检查集群状态**：查看节点状态、Pod状态、KubeSphere状态
- **集群健康检查**：100分制评分系统，多维度健康评估
- **查看系统日志**：查看各种系统和应用日志
- **生成故障报告**：生成详细的系统状态报告
- **快速修复手册**：显示常见问题的解决方法

### 4. 高级功能（菜单选项 18-20, 22）
- **性能监控**：实时监控CPU、内存、磁盘使用情况和K8S资源
- **备份集群配置**：备份K8S配置、虚拟机配置、网络配置
- **高级配置选项**：安装metrics-server、Ingress、存储类、网络策略、Helm
- **自动化运维**：定时健康检查、定时备份、资源监控报警

### 5. 管理功能（菜单选项 13-14）
- **强制重建集群**：完全清理并重建K8S集群
- **清理所有资源**：删除虚拟机和相关配置文件

## 技术特性

### 网络配置
- **桥接网络**: vmbr0
- **网络段**: 10.0.0.0/24
- **网关**: 10.0.0.1
- **DNS服务器**: 119.29.29.29, 8.8.8.8, 10.0.0.1
- **Pod子网**: 10.244.0.0/16
- **Service子网**: 10.96.0.0/12

### 虚拟机配置
- **操作系统**: Debian 12 (cloud image)
- **默认配置**: 
  - k8s-master: 4核CPU, 8GB内存, 80GB磁盘
  - k8s-worker1: 2核CPU, 4GB内存, 40GB磁盘
  - k8s-worker2: 2核CPU, 4GB内存, 40GB磁盘
- **SSH认证**: 密码认证 (root/123456)

### 容器运行时
- **Docker**: 最新版本，使用国内镜像源
- **containerd**: 作为K8S运行时
- **镜像加速**: 中科大、网易、百度镜像加速器

### K8S组件
- **版本**: 1.28.x
- **网络插件**: Calico
- **包管理**: apt (使用阿里云镜像源)
- **容器镜像**: registry.aliyuncs.com/google_containers

### 健康检查评分体系
- **虚拟机状态** (20分): 检查虚拟机运行状态
- **SSH连接** (15分): 检查SSH连接可用性
- **服务状态** (25分): 检查Docker、containerd、kubelet服务
- **集群状态** (25分): 检查K8S API服务器和节点状态
- **资源使用** (15分): 检查CPU、内存、磁盘使用率

### 自动化运维
- **定时健康检查**: 支持每小时、每4小时、每天或自定义频率
- **定时备份**: 支持每天、每周、每月或自定义频率
- **资源监控**: 每5分钟检查资源使用率，支持Webhook报警
- **日志管理**: 详细的操作日志和监控日志

## 错误处理和重试机制

### 网络问题处理
- **DNS配置**: 多个DNS服务器备用
- **镜像源**: 使用国内镜像源避免网络问题
- **超时设置**: SSH连接600s，Cloud-init 900s
- **重试机制**: 关键操作支持多次重试

### 安装问题处理
- **依赖检查**: 安装前检查所有依赖
- **清理机制**: 失败时自动清理残留配置
- **验证步骤**: 每个安装步骤都有验证机制
- **回滚支持**: 支持回滚到之前的状态

### SSH密钥管理
- **自动清理**: 创建虚拟机前自动清理旧SSH密钥
- **冲突处理**: 自动处理SSH主机密钥冲突
- **连接重试**: SSH连接失败时自动重试

## 日志和监控

### 日志系统
- **主日志**: `/var/log/pve-k8s-deploy.log`
- **健康检查日志**: `/var/log/k8s-health-check.log`
- **备份日志**: `/var/log/k8s-backup.log`
- **监控日志**: `/var/log/k8s-monitor.log`

### 监控指标
- **CPU使用率**: 实时监控和报警
- **内存使用率**: 实时监控和报警
- **磁盘使用率**: 实时监控和报警
- **K8S资源**: 节点状态、Pod状态、集群事件

### 报警机制
- **Webhook通知**: 支持自定义Webhook URL
- **阈值配置**: 可配置CPU、内存、磁盘使用率阈值
- **报警频率**: 每5分钟检查一次资源使用情况

## 备份和恢复

### 备份内容
- **K8S配置文件**: /etc/kubernetes目录
- **集群资源定义**: 所有namespace的资源YAML
- **虚拟机配置**: VM配置参数
- **网络配置**: 网络参数设置

### 备份策略
- **本地备份**: 备份到/var/backups/k8s目录
- **定时备份**: 支持多种频率的自动备份
- **备份清理**: 自动清理7天以上的旧备份
- **备份验证**: 备份完成后验证文件完整性

## 扩展功能

### Helm支持
- **自动安装**: 一键安装Helm 3
- **仓库配置**: 预配置常用Helm仓库
- **包管理**: 支持通过Helm安装应用

### Ingress控制器
- **NGINX Ingress**: 支持安装NGINX Ingress控制器
- **负载均衡**: 支持HTTP/HTTPS负载均衡
- **SSL终止**: 支持SSL证书管理

### 存储类
- **本地存储**: 配置本地存储类
- **动态供应**: 支持PV动态供应
- **存储扩展**: 支持存储卷扩展

### 网络策略
- **安全策略**: 配置默认网络安全策略
- **流量控制**: 控制Pod间网络流量
- **命名空间隔离**: 支持命名空间级别的网络隔离

## 使用场景

### 开发环境
- 快速搭建K8S开发环境
- 支持频繁的集群重建
- 完整的开发工具链

### 测试环境
- 自动化部署和测试
- 健康检查和监控
- 备份和恢复测试

### 生产环境
- 稳定的集群部署
- 完善的监控报警
- 自动化运维支持

### 学习环境
- 一键部署学习环境
- 详细的日志和文档
- 故障排查指南

## 总结

这个脚本已经从简单的部署工具演进为功能完整的K8S集群管理、监控、备份和自动化运维平台。它提供了：

1. **完整的部署流程**：从虚拟机创建到KubeSphere部署的全自动化
2. **强大的修复能力**：智能诊断和一键修复各种常见问题
3. **全面的监控体系**：100分制健康评分和实时资源监控
4. **自动化运维**：定时任务、报警通知、备份恢复
5. **高级功能扩展**：Helm、Ingress、存储、网络策略等

无论是开发、测试还是生产环境，这个脚本都能提供稳定、可靠的K8S集群管理解决方案。 