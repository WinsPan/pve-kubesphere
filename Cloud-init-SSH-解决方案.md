# Cloud-initè§£å†³Debian Root SSHç™»å½•é—®é¢˜

## ğŸ¯ **é—®é¢˜èƒŒæ™¯**

Debianç³»ç»Ÿé»˜è®¤ç¦ç”¨äº†rootç”¨æˆ·çš„SSHè¿œç¨‹ç™»å½•ï¼Œè¿™ä¼šå¯¼è‡´è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬æ— æ³•ç›´æ¥è¿æ¥åˆ°è™šæ‹Ÿæœºã€‚

## âœ… **è§£å†³æ–¹æ¡ˆï¼šCloud-initè‡ªåŠ¨é…ç½®**

### **æ–¹æ¡ˆä¼˜åŠ¿**
- **ğŸ”’ å®‰å…¨å¯æ§**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç²¾ç¡®æ§åˆ¶SSHè®¾ç½®
- **ğŸš€ è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜**ï¼šè™šæ‹Ÿæœºå¯åŠ¨æ—¶è‡ªåŠ¨åº”ç”¨é…ç½®
- **âš¡ æ— éœ€æ‰‹åŠ¨å¹²é¢„**ï¼šå®Œå…¨è‡ªåŠ¨åŒ–ï¼Œä¸éœ€è¦ç™»å½•è™šæ‹Ÿæœºæ‰‹åŠ¨é…ç½®
- **ğŸ”§ å¯å®šåˆ¶åŒ–**ï¼šå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´å„ç§ç³»ç»Ÿé…ç½®

### **å®ç°åŸç†**

1. **åˆ›å»ºCloud-initç”¨æˆ·æ•°æ®æ–‡ä»¶**ï¼š`/var/lib/vz/snippets/user-data-k8s.yml`
2. **è™šæ‹Ÿæœºåˆ›å»ºæ—¶è‡ªåŠ¨å¼•ç”¨**ï¼šé€šè¿‡ `--cicustom` å‚æ•°
3. **é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ**ï¼šCloud-initè¯»å–é…ç½®å¹¶åº”ç”¨

## ğŸ“‹ **é…ç½®å†…å®¹è¯¦è§£**

### **SSHé…ç½®**
```yaml
# SSHé…ç½® - å¯ç”¨rootç™»å½•
ssh_pwauth: true          # å¯ç”¨å¯†ç è®¤è¯
disable_root: false       # ä¸ç¦ç”¨rootç”¨æˆ·
ssh_deletekeys: false     # ä¸åˆ é™¤SSHå¯†é’¥

write_files:
  - path: /etc/ssh/sshd_config.d/99-root-login.conf
    content: |
      PermitRootLogin yes           # å…è®¸rootç™»å½•
      PasswordAuthentication yes    # å…è®¸å¯†ç è®¤è¯
      PubkeyAuthentication yes      # å…è®¸å…¬é’¥è®¤è¯
```

### **K8Sé¢„é…ç½®**
```yaml
# å†…æ ¸æ¨¡å—è‡ªåŠ¨åŠ è½½
- path: /etc/modules-load.d/k8s.conf
  content: |
    overlay
    br_netfilter

# å†…æ ¸å‚æ•°ä¼˜åŒ–
- path: /etc/sysctl.d/99-k8s.conf
  content: |
    net.bridge.bridge-nf-call-iptables = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward = 1
```

### **ç³»ç»Ÿåˆå§‹åŒ–**
```yaml
runcmd:
  - systemctl restart sshd      # é‡å¯SSHæœåŠ¡
  - modprobe overlay            # åŠ è½½å†…æ ¸æ¨¡å—
  - modprobe br_netfilter
  - sysctl --system            # åº”ç”¨å†…æ ¸å‚æ•°
  - swapoff -a                 # ç¦ç”¨swap
  - sed -i '/swap/d' /etc/fstab # æ°¸ä¹…ç¦ç”¨swap
```

## ğŸ”§ **è„šæœ¬ä¿®æ”¹è¯´æ˜**

### **1. æ·»åŠ Cloud-inité…ç½®åˆ›å»ºå‡½æ•°**
```bash
create_cloudinit_userdata() {
    local snippets_dir="/var/lib/vz/snippets"
    local userdata_file="$snippets_dir/user-data-k8s.yml"
    # åˆ›å»ºé…ç½®æ–‡ä»¶...
}
```

### **2. è™šæ‹Ÿæœºåˆ›å»ºæ—¶å¼•ç”¨é…ç½®**
```bash
qm create "$vm_id" \
    --cicustom "user=local:snippets/user-data-k8s.yml" \
    # å…¶ä»–å‚æ•°...
```

### **3. éƒ¨ç½²æµç¨‹ä¼˜åŒ–**
```bash
create_vms() {
    # 1. åˆ›å»ºCloud-inité…ç½®
    create_cloudinit_userdata
    
    # 2. åˆ›å»ºè™šæ‹Ÿæœºï¼ˆè‡ªåŠ¨åº”ç”¨é…ç½®ï¼‰
    for vm in vms; do
        qm create ...
    done
}
```

## ğŸš€ **ä½¿ç”¨æ•ˆæœ**

### **è‡ªåŠ¨å®Œæˆçš„é…ç½®**
- âœ… å¯ç”¨root SSHç™»å½•
- âœ… é…ç½®K8Sæ‰€éœ€å†…æ ¸æ¨¡å—
- âœ… ä¼˜åŒ–ç½‘ç»œå‚æ•°
- âœ… ç¦ç”¨swapåˆ†åŒº
- âœ… å®‰è£…åŸºç¡€è½¯ä»¶åŒ…
- âœ… é…ç½®æ—¶åŒºå’Œä¸»æœºå

### **éƒ¨ç½²æµç¨‹**
1. **åˆ›å»ºé…ç½®æ–‡ä»¶** â†’ Cloud-initç”¨æˆ·æ•°æ®
2. **åˆ›å»ºè™šæ‹Ÿæœº** â†’ è‡ªåŠ¨å¼•ç”¨é…ç½®
3. **é¦–æ¬¡å¯åŠ¨** â†’ Cloud-initè‡ªåŠ¨æ‰§è¡Œé…ç½®
4. **SSHè¿æ¥** â†’ ç›´æ¥ä½¿ç”¨rootç”¨æˆ·è¿æ¥
5. **éƒ¨ç½²K8S** â†’ æ— éœ€é¢å¤–é…ç½®

## ğŸ” **å®‰å…¨è€ƒè™‘**

### **å®‰å…¨æªæ–½**
- ä»…åœ¨å†…ç½‘ç¯å¢ƒä½¿ç”¨root SSH
- å¯ä»¥é…ç½®SSHå¯†é’¥è®¤è¯
- å¯ä»¥é™åˆ¶SSHè®¿é—®IPèŒƒå›´
- éƒ¨ç½²å®Œæˆåå¯ä»¥é‡æ–°ç¦ç”¨root SSH

### **ç”Ÿäº§ç¯å¢ƒå»ºè®®**
```yaml
# å¯ä»¥æ·»åŠ æ›´ä¸¥æ ¼çš„SSHé…ç½®
write_files:
  - path: /etc/ssh/sshd_config.d/99-security.conf
    content: |
      PermitRootLogin prohibit-password  # ä»…å…è®¸å¯†é’¥è®¤è¯
      AllowUsers root@10.0.0.0/24       # é™åˆ¶è®¿é—®IPèŒƒå›´
      MaxAuthTries 3                     # é™åˆ¶è®¤è¯å°è¯•æ¬¡æ•°
```

## ğŸ“ **æ€»ç»“**

è¿™ä¸ªCloud-initè§£å†³æ–¹æ¡ˆå®Œç¾è§£å†³äº†Debian root SSHç™»å½•é—®é¢˜ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **ğŸ¯ é’ˆå¯¹æ€§å¼º**ï¼šä¸“é—¨è§£å†³PVE+Debian+K8Séƒ¨ç½²åœºæ™¯
- **ğŸ”§ è‡ªåŠ¨åŒ–é«˜**ï¼šæ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼Œä¸€é”®éƒ¨ç½²
- **âš¡ æ•ˆç‡ä¼˜åŒ–**ï¼šé¢„é…ç½®K8Sç›¸å…³è®¾ç½®ï¼Œå‡å°‘éƒ¨ç½²æ—¶é—´
- **ğŸ”’ å®‰å…¨å¯æ§**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç²¾ç¡®æ§åˆ¶æƒé™
- **ğŸ“ˆ å¯æ‰©å±•**ï¼šå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šè‡ªåŠ¨åŒ–é…ç½®

ç°åœ¨ä½ çš„è„šæœ¬å¯ä»¥å®Œç¾å¤„ç†Debiançš„root SSHç™»å½•é™åˆ¶é—®é¢˜äº†ï¼ 