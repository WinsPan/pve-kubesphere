# PVE K8S+KubeSphere 一键部署脚本

## 功能特性

- 🚀 **一键部署**：自动创建3台KVM虚拟机，部署K8S集群和KubeSphere
- 🔧 **智能诊断**：内置诊断功能，快速定位问题
- 📦 **无人值守**：使用cloud-init自动配置系统
- 🌐 **多源下载**：支持多个镜像源，提高下载成功率
- 🔄 **自动重试**：关键步骤支持自动重试机制
- 📊 **详细日志**：完整的部署日志记录
- 🎯 **交互菜单**：友好的菜单界面，操作简单

## 系统要求

- PVE 7.0+ 环境
- 至少 48GB 内存（3台虚拟机 × 16GB）
- 至少 1TB 存储空间
- 网络连接正常

## 使用方法

### 1. 交互式菜单（推荐）
```bash
./one-click-pve-k8s.sh
```
运行后会显示菜单，可以选择：
- 部署K8S+KubeSphere集群
- 诊断系统状态
- 清理虚拟机资源
- 查看部署信息
- 检查依赖环境

### 2. 命令行直接执行
```bash
# 直接部署
./one-click-pve-k8s.sh deploy

# 诊断系统状态
./one-click-pve-k8s.sh diagnose

# 清理虚拟机资源
./one-click-pve-k8s.sh clean

# 查看部署信息
./one-click-pve-k8s.sh info

# 检查依赖环境
./one-click-pve-k8s.sh check
```

## 菜单功能说明

### 1. 部署K8S+KubeSphere集群
- 自动下载最新Debian ISO
- 创建3台KVM虚拟机
- 配置cloud-init无人值守安装
- 部署Kubernetes集群
- 安装KubeSphere控制台

### 2. 诊断系统状态
- 检查PVE环境状态
- 验证虚拟机运行状态
- 测试网络连接
- 检查SSH服务可用性
- 分析系统资源配置
- 提供问题解决建议

### 3. 清理虚拟机资源
- 安全停止虚拟机
- 删除虚拟机及其存储
- 释放系统资源
- 确认操作防止误删

### 4. 查看部署信息
- 显示虚拟机配置详情
- 列出资源分配情况
- 提供网络配置信息
- 显示访问地址和凭据

### 5. 检查依赖环境
- 验证PVE环境
- 检查必需工具
- 分析系统资源
- 提供安装建议

## 部署配置

### 虚拟机配置
- **Master节点**: k8s-master (ID: 101, IP: 10.0.0.10)
- **Worker节点1**: k8s-worker1 (ID: 102, IP: 10.0.0.11)  
- **Worker节点2**: k8s-worker2 (ID: 103, IP: 10.0.0.12)

### 资源分配
- CPU: 8核/节点
- 内存: 16GB/节点
- 存储: 300GB/节点
- 系统: Debian 12 (最新版本)

### 网络配置
- 网桥: vmbr0
- 网关: 10.0.0.1
- DNS: 10.0.0.2, 119.29.29.29
- 用户: root
- 密码: kubesphere123

## 部署流程

1. **环境检查**：检查PVE环境和依赖工具
2. **ISO下载**：自动获取最新Debian ISO
3. **虚拟机创建**：创建3台KVM虚拟机
4. **系统启动**：批量启动虚拟机
5. **SSH等待**：等待虚拟机SSH服务可用
6. **系统初始化**：安装基础软件包
7. **K8S部署**：安装Kubernetes集群
8. **KubeSphere安装**：部署KubeSphere控制台

## 常见问题

### 1. 脚本在启动虚拟机后停止
**原因**：SSH等待超时或网络配置问题
**解决**：运行诊断模式检查问题
```bash
./one-click-pve-k8s.sh diagnose
```

### 2. 虚拟机无法启动
**原因**：PVE资源不足
**解决**：检查内存和存储空间
```bash
./one-click-pve-k8s.sh check
```

### 3. 网络不通
**原因**：网络配置错误
**解决**：检查vmbr0配置
```bash
ip addr show vmbr0
```

### 4. SSH连接失败
**原因**：cloud-init配置问题
**解决**：检查虚拟机配置
```bash
qm config 101
```

## 访问信息

部署完成后：
- **KubeSphere控制台**: http://10.0.0.10:30880
- **默认用户名**: admin
- **默认密码**: P@88w0rd

## 日志文件

- **部署日志**: `deploy.log`
- **诊断日志**: `diagnose.log`

## 清理资源

### 通过菜单清理
```bash
./one-click-pve-k8s.sh
# 选择选项 3: 清理虚拟机资源
```

### 通过命令行清理
```bash
./one-click-pve-k8s.sh clean
```

### 手动清理
```bash
qm stop 101 102 103
qm destroy 101 102 103
```

## 注意事项

1. 确保PVE环境有足够的资源
2. 网络配置正确，虚拟机能够获取IP
3. 首次部署可能需要较长时间（30-60分钟）
4. 建议在部署前运行诊断模式检查环境
5. 如遇到问题，查看详细日志文件
6. 清理操作会删除所有虚拟机数据，请谨慎操作

## 使用建议

1. **首次使用**：先运行 `./one-click-pve-k8s.sh check` 检查环境
2. **部署前**：运行 `./one-click-pve-k8s.sh diagnose` 诊断系统状态
3. **部署中**：使用 `tail -f deploy.log` 监控部署进度
4. **部署后**：通过菜单查看部署信息获取访问地址
5. **清理时**：使用菜单清理功能，避免误操作

## 技术支持

如遇到问题，请：
1. 运行诊断模式获取系统状态
2. 查看日志文件了解详细错误信息
3. 检查PVE环境和网络配置
4. 确保所有依赖工具已安装 